import { PrismaClient, ChatRoomType, ChatRole, MessageType, NotificationType } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function seedChat() {
  console.log('üí¨ Starting Real-time Chat seed...');

  try {
    // Create chat users if they don't exist
    console.log('üë• Creating chat users...');
    
    const passwordHash = await bcrypt.hash('chat123', 10);

    const users = [
      {
        email: 'alice@team.com',
        name: 'Alice Johnson',
        image: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face'
      },
      {
        email: 'bob@team.com',
        name: 'Bob Smith',
        image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face'
      },
      {
        email: 'carol@team.com',
        name: 'Carol Davis',
        image: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face'
      },
      {
        email: 'david@team.com',
        name: 'David Chen',
        image: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face'
      },
      {
        email: 'eva@team.com',
        name: 'Eva Rodriguez',
        image: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=150&h=150&fit=crop&crop=face'
      },
      {
        email: 'frank@team.com',
        name: 'Frank Wilson',
        image: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face'
      }
    ];

    const createdUsers = [];
    for (const userData of users) {
      const user = await prisma.user.upsert({
        where: { email: userData.email },
        update: {},
        create: {
          ...userData,
          password: passwordHash,
          role: 'user',
          emailVerified: new Date()
        }
      });
      createdUsers.push(user);
    }

    console.log('‚úÖ Created chat users');

    // Create chat rooms
    console.log('üè† Creating chat rooms...');

    // General team room
    const generalRoom = await prisma.chatRoom.upsert({
      where: { id: 'general-team-room' },
      update: {},
      create: {
        id: 'general-team-room',
        name: 'General',
        description: 'General team discussions and announcements',
        type: ChatRoomType.CHANNEL,
        isPrivate: false,
        avatar: 'üí¨',
        createdBy: createdUsers[0].id,
        maxMembers: 50,
        settings: JSON.stringify({
          allowFileUploads: true,
          allowReactions: true,
          allowThreads: true,
          muteNotifications: false
        })
      }
    });

    // Development team room
    const devRoom = await prisma.chatRoom.upsert({
      where: { id: 'dev-team-room' },
      update: {},
      create: {
        id: 'dev-team-room',
        name: 'Development',
        description: 'Development team discussions, code reviews, and tech talks',
        type: ChatRoomType.GROUP,
        isPrivate: false,
        avatar: 'üíª',
        createdBy: createdUsers[1].id,
        maxMembers: 20,
        settings: JSON.stringify({
          allowFileUploads: true,
          allowReactions: true,
          allowThreads: true,
          requireApproval: false
        })
      }
    });

    // Design team room
    const designRoom = await prisma.chatRoom.upsert({
      where: { id: 'design-team-room' },
      update: {},
      create: {
        id: 'design-team-room',
        name: 'Design',
        description: 'Design team creativity and feedback',
        type: ChatRoomType.GROUP,
        isPrivate: false,
        avatar: 'üé®',
        createdBy: createdUsers[2].id,
        maxMembers: 15,
        settings: JSON.stringify({
          allowFileUploads: true,
          allowReactions: true,
          allowThreads: true,
          theme: 'creative'
        })
      }
    });

    // Direct message room (Alice & Bob)
    const directRoom = await prisma.chatRoom.upsert({
      where: { id: 'alice-bob-direct' },
      update: {},
      create: {
        id: 'alice-bob-direct',
        name: 'Alice & Bob',
        type: ChatRoomType.DIRECT,
        isPrivate: true,
        createdBy: createdUsers[0].id,
        maxMembers: 2,
        settings: JSON.stringify({
          encryptMessages: true,
          deleteAfter: null
        })
      }
    });

    // Support room
    const supportRoom = await prisma.chatRoom.upsert({
      where: { id: 'support-room' },
      update: {},
      create: {
        id: 'support-room',
        name: 'Help & Support',
        description: 'Get help from our support team',
        type: ChatRoomType.SUPPORT,
        isPrivate: false,
        avatar: 'üÜò',
        createdBy: createdUsers[3].id,
        maxMembers: 100,
        settings: JSON.stringify({
          autoAssignAgent: true,
          businessHoursOnly: false,
          priority: 'high'
        })
      }
    });

    console.log('‚úÖ Created chat rooms');

    // Create participants
    console.log('üë§ Creating room participants...');

    const participantData = [
      // General room - everyone
      { roomId: generalRoom.id, userId: createdUsers[0].id, role: ChatRole.OWNER, permissions: ['*'] },
      { roomId: generalRoom.id, userId: createdUsers[1].id, role: ChatRole.ADMIN, permissions: ['moderate', 'invite', 'manage_messages'] },
      { roomId: generalRoom.id, userId: createdUsers[2].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: generalRoom.id, userId: createdUsers[3].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: generalRoom.id, userId: createdUsers[4].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: generalRoom.id, userId: createdUsers[5].id, role: ChatRole.MEMBER, permissions: [] },

      // Dev room - developers
      { roomId: devRoom.id, userId: createdUsers[1].id, role: ChatRole.OWNER, permissions: ['*'] },
      { roomId: devRoom.id, userId: createdUsers[0].id, role: ChatRole.ADMIN, permissions: ['moderate', 'invite'] },
      { roomId: devRoom.id, userId: createdUsers[3].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: devRoom.id, userId: createdUsers[4].id, role: ChatRole.MEMBER, permissions: [] },

      // Design room - designers and stakeholders
      { roomId: designRoom.id, userId: createdUsers[2].id, role: ChatRole.OWNER, permissions: ['*'] },
      { roomId: designRoom.id, userId: createdUsers[0].id, role: ChatRole.ADMIN, permissions: ['moderate'] },
      { roomId: designRoom.id, userId: createdUsers[4].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: designRoom.id, userId: createdUsers[5].id, role: ChatRole.MEMBER, permissions: [] },

      // Direct message
      { roomId: directRoom.id, userId: createdUsers[0].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: directRoom.id, userId: createdUsers[1].id, role: ChatRole.MEMBER, permissions: [] },

      // Support room
      { roomId: supportRoom.id, userId: createdUsers[3].id, role: ChatRole.OWNER, permissions: ['*'] },
      { roomId: supportRoom.id, userId: createdUsers[0].id, role: ChatRole.ADMIN, permissions: ['moderate', 'assign_tickets'] },
      { roomId: supportRoom.id, userId: createdUsers[1].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: supportRoom.id, userId: createdUsers[2].id, role: ChatRole.MEMBER, permissions: [] },
      { roomId: supportRoom.id, userId: createdUsers[4].id, role: ChatRole.MEMBER, permissions: [] }
    ];

    for (const participant of participantData) {
      await prisma.chatParticipant.upsert({
        where: {
          roomId_userId: {
            roomId: participant.roomId,
            userId: participant.userId
          }
        },
        update: {},
        create: {
          ...participant,
          joinedAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000), // Random join time in last 30 days
          lastSeenAt: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000), // Random last seen in last 24 hours
          notificationSettings: JSON.stringify({
            muted: false,
            desktop: true,
            mobile: true,
            email: false
          })
        }
      });
    }

    console.log('‚úÖ Created room participants');

    // Create sample messages
    console.log('üí¨ Creating sample messages...');

    const sampleMessages = [
      // General room messages
      {
        roomId: generalRoom.id,
        userId: createdUsers[0].id,
        content: '¬°Bienvenidos al canal general del equipo! üéâ Aqu√≠ compartiremos updates importantes y celebraremos nuestros logros.',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: generalRoom.id,
        userId: createdUsers[1].id,
        content: '¬°Excelente! Me encanta tener un espacio centralizado para el equipo. üí™',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000 + 5 * 60 * 1000)
      },
      {
        roomId: generalRoom.id,
        userId: createdUsers[2].id,
        content: 'Perfecto para mantenernos sincronizados. ¬øTendremos daily standups aqu√≠? ü§î',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: generalRoom.id,
        userId: createdUsers[0].id,
        content: 'Great idea! Podemos hacer quick check-ins aqu√≠ los lunes, mi√©rcoles y viernes üìÖ',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000 + 10 * 60 * 1000)
      },
      {
        roomId: generalRoom.id,
        userId: null, // System message
        content: 'Eva Rodriguez se uni√≥ al canal',
        type: MessageType.SYSTEM,
        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: generalRoom.id,
        userId: createdUsers[4].id,
        content: '¬°Hola team! Emocionada de estar aqu√≠ üåü',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000 + 2 * 60 * 1000)
      },

      // Dev room messages
      {
        roomId: devRoom.id,
        userId: createdUsers[1].id,
        content: 'üöÄ Nueva release en staging! Pueden hacer testing de las nuevas features.',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: devRoom.id,
        userId: createdUsers[3].id,
        content: 'Awesome! ¬øYa est√° el user authentication funcionando? üîê',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000 + 15 * 60 * 1000)
      },
      {
        roomId: devRoom.id,
        userId: createdUsers[1].id,
        content: 'S√≠! NextAuth.js est√° configurado con Google, GitHub y email/password üíØ',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000 + 20 * 60 * 1000)
      },
      {
        roomId: devRoom.id,
        userId: createdUsers[4].id,
        content: 'Perfect! ¬øNecesitan help con los tests? Puedo escribir algunos e2e tests üß™',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: devRoom.id,
        userId: createdUsers[1].id,
        content: 'That would be amazing Eva! Los tests de Playwright estar√≠an geniales üé≠',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000 + 5 * 60 * 1000)
      },

      // Design room messages
      {
        roomId: designRoom.id,
        userId: createdUsers[2].id,
        content: 'üé® Working on the new dashboard design. ¬øQu√© opinan de estos mockups?',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: designRoom.id,
        userId: createdUsers[0].id,
        content: 'Love the clean aesthetic! Los colores est√°n perfect para el branding üåà',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000 + 30 * 60 * 1000)
      },
      {
        roomId: designRoom.id,
        userId: createdUsers[4].id,
        content: '¬øPodr√≠amos hacer the navigation un poco m√°s accessible? Maybe larger touch targets üì±',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000)
      },
      {
        roomId: designRoom.id,
        userId: createdUsers[2].id,
        content: 'Excellent point! Accessibility es super importante. Voy a ajustar los sizes ‚ôø',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000 + 10 * 60 * 1000)
      },

      // Direct messages
      {
        roomId: directRoom.id,
        userId: createdUsers[0].id,
        content: '¬øTienes tiempo for a quick sync about the project roadmap? üó∫Ô∏è',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 3 * 60 * 60 * 1000)
      },
      {
        roomId: directRoom.id,
        userId: createdUsers[1].id,
        content: 'Sure! Estoy free en 30 minutos. ¬øVideo call o here? üìû',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 2.5 * 60 * 60 * 1000)
      },
      {
        roomId: directRoom.id,
        userId: createdUsers[0].id,
        content: 'Video call ser√≠a better. Sending calendar invite! üìÖ',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000)
      },

      // Support room messages
      {
        roomId: supportRoom.id,
        userId: createdUsers[4].id,
        content: 'üÜò Help! No puedo upload files en el dashboard. ¬øEs un known issue?',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000)
      },
      {
        roomId: supportRoom.id,
        userId: createdUsers[3].id,
        content: 'Hey Eva! Let me check that for you. ¬øQu√© browser est√°s usando? üåê',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000 + 2 * 60 * 1000)
      },
      {
        roomId: supportRoom.id,
        userId: createdUsers[4].id,
        content: 'Chrome Version 120 on macOS. Files are PDFs around 2MB üìÑ',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 3.5 * 60 * 60 * 1000)
      },
      {
        roomId: supportRoom.id,
        userId: createdUsers[3].id,
        content: 'Found the issue! Hay un bug with PDF uploads. Fix coming in next release üêõ‚Üí‚úÖ',
        type: MessageType.TEXT,
        createdAt: new Date(Date.now() - 3 * 60 * 60 * 1000)
      }
    ];

    const createdMessages = [];
    for (const messageData of sampleMessages) {
      const message = await prisma.chatMessage.create({
        data: messageData
      });
      createdMessages.push(message);
    }

    console.log('‚úÖ Created sample messages');

    // Add some threaded replies
    console.log('üßµ Creating threaded replies...');

    const threadReplies = [
      {
        roomId: devRoom.id,
        userId: createdUsers[0].id,
        content: 'Tambi√©n agregu√© rate limiting para security üîí',
        type: MessageType.TEXT,
        parentId: createdMessages.find(m => m.content.includes('NextAuth.js est√° configurado'))?.id,
        createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000 + 25 * 60 * 1000)
      },
      {
        roomId: devRoom.id,
        userId: createdUsers[3].id,
        content: 'Nice! ¬øQu√© strategy usaste? Redis-based? üèéÔ∏è',
        type: MessageType.TEXT,
        parentId: createdMessages.find(m => m.content.includes('NextAuth.js est√° configurado'))?.id,
        createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000 + 35 * 60 * 1000)
      },
      {
        roomId: designRoom.id,
        userId: createdUsers[5].id,
        content: 'The color contrast looks great! WCAG AA compliant? ‚úÖ',
        type: MessageType.TEXT,
        parentId: createdMessages.find(m => m.content.includes('Love the clean aesthetic'))?.id,
        createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000 + 45 * 60 * 1000)
      }
    ];

    for (const replyData of threadReplies) {
      if (replyData.parentId) {
        await prisma.chatMessage.create({
          data: replyData
        });
      }
    }

    console.log('‚úÖ Created threaded replies');

    // Add reactions to messages
    console.log('üòä Adding message reactions...');

    const reactions = [
      { messageId: createdMessages[0].id, userId: createdUsers[1].id, emoji: 'üéâ' },
      { messageId: createdMessages[0].id, userId: createdUsers[2].id, emoji: 'üéâ' },
      { messageId: createdMessages[0].id, userId: createdUsers[3].id, emoji: 'üëç' },
      { messageId: createdMessages[1].id, userId: createdUsers[0].id, emoji: 'üí™' },
      { messageId: createdMessages[1].id, userId: createdUsers[2].id, emoji: 'üëç' },
      { messageId: createdMessages[6].id, userId: createdUsers[0].id, emoji: 'üöÄ' },
      { messageId: createdMessages[6].id, userId: createdUsers[3].id, emoji: 'üî•' },
      { messageId: createdMessages[6].id, userId: createdUsers[4].id, emoji: 'üî•' },
      { messageId: createdMessages[10].id, userId: createdUsers[1].id, emoji: 'üé≠' },
      { messageId: createdMessages[12].id, userId: createdUsers[0].id, emoji: 'üé®' },
      { messageId: createdMessages[12].id, userId: createdUsers[4].id, emoji: 'üíØ' }
    ];

    for (const reaction of reactions) {
      try {
        await prisma.chatReaction.create({
          data: reaction
        });
      } catch (error) {
        // Skip if reaction already exists
      }
    }

    console.log('‚úÖ Added message reactions');

    // Add read receipts
    console.log('üëÅÔ∏è Creating read receipts...');

    for (const message of createdMessages.slice(0, 15)) { // Add read receipts for first 15 messages
      const roomParticipants = await prisma.chatParticipant.findMany({
        where: { roomId: message.roomId },
        select: { userId: true }
      });

      for (const participant of roomParticipants) {
        // Don't create read receipt for message author
        if (participant.userId !== message.userId) {
          try {
            await prisma.chatReadReceipt.create({
              data: {
                messageId: message.id,
                userId: participant.userId,
                readAt: new Date(message.createdAt.getTime() + Math.random() * 60 * 60 * 1000) // Read within an hour
              }
            });
          } catch (error) {
            // Skip if already exists
          }
        }
      }
    }

    console.log('‚úÖ Created read receipts');

    // Add some typing indicators (simulating current activity)
    console.log('‚å®Ô∏è Adding typing indicators...');

    const typingIndicators = [
      { roomId: generalRoom.id, userId: createdUsers[5].id, isTyping: true },
      { roomId: devRoom.id, userId: createdUsers[4].id, isTyping: true }
    ];

    for (const indicator of typingIndicators) {
      await prisma.chatTypingIndicator.create({
        data: {
          ...indicator,
          lastTypedAt: new Date()
        }
      });
    }

    console.log('‚úÖ Added typing indicators');

    // Create some notifications
    console.log('üîî Creating notifications...');

    const notifications = [
      {
        userId: createdUsers[0].id,
        roomId: devRoom.id,
        messageId: createdMessages.find(m => m.content.includes('Awesome! ¬øYa est√° el user authentication'))?.id,
        type: NotificationType.MENTION,
        title: 'Nueva menci√≥n en Development',
        content: 'David Chen te mencion√≥ en Development',
        isRead: false
      },
      {
        userId: createdUsers[2].id,
        roomId: designRoom.id,
        type: NotificationType.MESSAGE,
        title: 'Nuevo mensaje en Design',
        content: 'Eva Rodriguez envi√≥ un mensaje',
        isRead: true,
        readAt: new Date()
      },
      {
        userId: createdUsers[1].id,
        roomId: directRoom.id,
        messageId: createdMessages.find(m => m.content.includes('tiempo for a quick sync'))?.id,
        type: NotificationType.MESSAGE,
        title: 'Mensaje directo de Alice',
        content: '¬øTienes tiempo for a quick sync about...',
        isRead: false
      }
    ];

    for (const notification of notifications) {
      if (notification.messageId) {
        await prisma.chatNotification.create({
          data: notification
        });
      }
    }

    console.log('‚úÖ Created notifications');

    console.log('\nüéâ Real-time Chat seed completed successfully!');
    console.log('\nüìä Summary:');
    console.log(`   ‚Ä¢ 6 chat users created`);
    console.log(`   ‚Ä¢ 5 chat rooms created (General, Dev, Design, Direct, Support)`);
    console.log(`   ‚Ä¢ 21 room participants added`);
    console.log(`   ‚Ä¢ ${createdMessages.length} messages created`);
    console.log(`   ‚Ä¢ 3 threaded replies added`);
    console.log(`   ‚Ä¢ 11 message reactions added`);
    console.log(`   ‚Ä¢ Read receipts for active messages`);
    console.log(`   ‚Ä¢ 2 active typing indicators`);
    console.log(`   ‚Ä¢ 3 sample notifications`);
    
    console.log('\nüîë Test Login Credentials:');
    console.log('   alice@team.com:chat123 (Team Lead)');
    console.log('   bob@team.com:chat123 (Senior Developer)');
    console.log('   carol@team.com:chat123 (Lead Designer)');
    console.log('   david@team.com:chat123 (DevOps Engineer)');
    console.log('   eva@team.com:chat123 (QA Engineer)');
    console.log('   frank@team.com:chat123 (Product Manager)');

    console.log('\nüí¨ Chat Features Ready:');
    console.log('   ‚úÖ Multi-room support (Direct, Group, Channel, Support)');
    console.log('   ‚úÖ Real-time messaging with reactions');
    console.log('   ‚úÖ Threaded conversations');
    console.log('   ‚úÖ Read receipts and typing indicators');
    console.log('   ‚úÖ Role-based permissions');
    console.log('   ‚úÖ File attachments support');
    console.log('   ‚úÖ Notification system');
    console.log('   ‚úÖ Message editing and deletion');

  } catch (error) {
    console.error('‚ùå Error seeding chat data:', error);
    throw error;
  }
}

export default seedChat;

// Run the seed if this file is executed directly
if (require.main === module) {
  seedChat()
    .catch((e) => {
      console.error(e);
      process.exit(1);
    })
    .finally(async () => {
      await prisma.$disconnect();
    });
}